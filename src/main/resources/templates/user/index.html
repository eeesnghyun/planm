<!DOCTYPE html>
<html lang="ko"
	  xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.w3.org/1999/xhtml"
      layout:decorate="~{index}">
<head>
    <meta charset="UTF-8">
    
	<link rel="stylesheet" href="/plugins/grid/tabulator/tabulator_semanticui.min.css" type="text/css"/>    
</head>      
<th:block layout:fragment="content-area">
	<div class="container-fluid">
		<div class="row pb-2 border-bottom">
			<div class="col-12">
				<button type="button" class="btn btn-outline-secondary">엑셀 일괄등록</button>
			</div>
		</div>
		
		<div class="row mt-2" id="divUser">
			<div class="col-3 text-center">
				<p>
					<img class="img-thumbnail" src="/images/userImg.png" id="userImg" style="width: 150px; height: 150px;">
					<input type="hidden" id="imgSource" value="">
				</p>
				
				<div class="ipt-file">
			    	<input type="text" readonly="readonly" id="fileName">
			        <label>
			            업로드
			            <input type="file" onchange="readUserImg(this)">
			        </label>
			    </div>
			</div>
			
			<div class="col-9">
				<div class="container-fluid">					
					<div class="row">
						<div class="col-12">
							<div class="form-group row">								
								<label class="col-sm-1 col-form-label">이름/사번</label>
							    <div class="col-sm-3">
							    	<div class="form-inline">
								    	<input type="text" class="form-control" id="userName" style="width: 100px;"> / 
								    	<input type="text" class="form-control" id="userCode" style="width: 100px;" disabled="disabled">
							    	</div>
							    </div>
							    
							    <label class="col-sm-1 col-form-label">생년월일</label>
							    <div class="col-sm-2">
							    	<input type="text" class="form-control" id="birthYmd" name="formDatePicker">
							    </div>
							    
							    <label class="col-sm-1 col-form-label">성별</label>
							    <div class="col-sm-2">
							    	<div class="pt-2">
								    	<div class="form-check form-check-inline">
											<input class="form-check-input" type="radio" name="gender" id="male" value="male" checked="checked">
										  	<label class="form-check-label" for="mail">남</label>
										</div>
										<div class="form-check form-check-inline">
										  	<input class="form-check-input" type="radio" name="gender" id="female" value="female">
										  	<label class="form-check-label" for="femail">녀</label>
										</div>
									</div>
							    </div>
							</div>
							
							<div class="form-group row">
								<label for="inputPassword" class="col-sm-1 col-form-label">연락처</label>
							    <div class="col-sm-3">
							    	<input type="text" class="form-control" id="mobile" placeholder="휴대폰 번호 '-'표 없이 입력해주세요.">
							    </div>
							    
							    <label class="col-sm-1 col-form-label">이메일</label>
							    <div class="col-sm-7">
							    	<div class="form-row align-items-center">
									    <div class="col">									    	
									      	<input type="text" class="form-control" id="email">
									    </div>
									    <div class="col">									    	
									      	<div class="input-group">
									        	<div class="input-group-prepend">
									          		<div class="input-group-text">@</div>
									        	</div>
									        	<select class="form-control" id="emailServer">
									        		<option value="">선택</option>
									        		<option value="gmail.com">gmail.com</option>
									        		<option value="naver.com">naver.com</option>
									        		<option value="hanmail.net">hanmail.net</option>
									        		<option value="daum.net">daum.net</option>
									        		<option value="nate.com">nate.com</option>
									        		<option value="hotmail.com">hotmail.com</option>
									        	</select>
									      	</div>
									    </div>									    
									 </div>
							    </div>							    
							</div>
							
							<div class="form-group row">
								<label class="col-sm-1 col-form-label">부서</label>
							    <div class="col-sm-3">
							    	<select class="form-control" id="deptCode" onchange="getPartList(this.value)"></select>
							    </div>

							    <label class="col-sm-1 col-form-label">파트</label>
							    <div class="col-sm-3">
							    	<select class="form-control" id="partCode"></select>
							    </div>
							    
							    <label class="col-sm-1 col-form-label">직책</label>
							    <div class="col-sm-3">
							    	<select class="form-control" id="jobPos"></select>
							    </div>				    				    
							</div>
							
							<div class="form-group row">
								<label class="col-sm-1 col-form-label">입사일</label>
							    <div class="col-sm-3">
							    	<input type="text" class="form-control" id="enterYmd" name="formDatePicker">
							    </div>
							    
							    <label class="col-sm-1 col-form-label">퇴사일</label>
							    <div class="col-sm-4">
							    	<input type="text" class="form-control" id="retireYmd" name="formDatePicker">
							    </div>				    				    
							</div>
						</div>
					</div>	<!-- End row -->
				</div>		<!-- End container -->
			</div>
		</div>	<!-- End row -->
		
		<div class="row">
			<div class="col-12 border-bottom pb-3">
				<div class="float-right">
					<button type="button" class="btn btn-outline-secondary" id="newBtn">신규</button>
					<button type="button" class="btn btn-outline-secondary" id="saveBtn" onclick="saveUser()">저장</button>
					<button type="button" class="btn btn-outline-secondary" id="updateBtn" onclick="updateUser()" style="display: none;">수정</button>
				</div>
			</div>			
		</div>	<!-- End row -->
				
		<div class="row">
			<div class="col-12">
				<div id="gridUser"></div>
			</div>
		</div>	<!-- End row -->
	</div>		<!-- End container -->
	
	<script src="/plugins/grid/tabulator/tabulator.min.js"></script>	
	<script src="/plugins/grid/tabulator/xlsx.full.min.js"></script>
	<script>
		var grid = null;				
		
		const readUserImg = function(input) {			
			$("#fileName").val(input.files[0].name);
			
			if (input.files && input.files[0]) {
				const file = input.files[0];
				
				if (file.size > 300000) {
		            alert("파일 사이즈가 너무 큽니다.")
		            return;
		        }
				
				var fileReader = new FileReader();
				
				fileReader.onload = function(e) {
					$("#userImg").attr("src", e.target.result);
					$("#imgSource").val(e.target.result);
				};       
				fileReader.readAsDataURL(file);
			}
		};
		
		const isValid = function() {
			if (commonIsNull($("#userName").val())) {
				$("#userName").addClass("is-invalid");
				alert("이름을 입력해주세요.")
				return false;
			}
			
			if (commonIsNull($("#birthYmd").val())) {
				$("#birthYmd").addClass("is-invalid");
				alert("생년월일을 입력해주세요.")
				return false;
			}
			
			if (commonIsNull($("#email").val()) || commonIsNull($("#emailServer").val())) {
				if (commonIsNull($("#email").val())) $("#email").addClass("is-invalid");
				if (commonIsNull($("#emailServer").val())) $("#emailServer").addClass("is-invalid");
					
				alert("이메일을 입력해주세요.");
				return false;
			} 
						
			if (commonIsNull($("#deptCode").val()) || commonIsNull($("#partCode").val())) {
				if (commonIsNull($("#deptCode").val())) $("#deptCode").addClass("is-invalid");
				if (commonIsNull($("#partCode").val())) $("#partCode").addClass("is-invalid");
				
				alert("부서/파트를 선택해주세요.");
				return false;
			}

			if (commonIsNull($("#enterYmd").val())) {
				$("#enterYmd").addClass("is-invalid");
				alert("입사일을 입력해주세요.")
				return false;
			}
			
			return true;
		}
		
		const saveUser = function() {
			if (isValid()) {
				const email = $("#email").val().replace(/\@/g,'') + "@" + $("#emailServer").val();
				
				const params = {
					"userName"  : $("#userName").val(),
					"birthYmd"  : $("#birthYmd").val(),
					"gender"    : $("input[name=gender]:checked").val(),
					"mobile"    : $("#mobile").val(),
					"email"     : email,
					"deptCode"  : $("#deptCode").val(),
					"partCode"  : $("#partCode").val(),
					"jobPos"    : $("#jobPos").val(),
					"userImg"   : $("#imgSource").val(),
					"enterYmd"  : $("#enterYmd").val(),
					"retireYmd" : $("#retireYmd").val()
				};
				const data = commonCallAjax("/user/save", params);
				
				if (data.code == "ok") {				
					alert("등록되었습니다.");
					
					commonResetForm("divUser");
					initGrid();
				}	
			}						
		};
		
		const updateUser = function() {
			if (isValid()) {
				const email = $("#email").val().replace(/\@/g,'') + "@" + $("#emailServer").val();
				
				const params = {
					"userCode" : $("#userCode").val(),
					"userName"  : $("#userName").val(),
					"birthYmd"  : $("#birthYmd").val(),
					"gender"    : $("input[name=gender]:checked").val(),
					"mobile"    : $("#mobile").val(),
					"email"     : email,
					"deptCode"  : $("#deptCode").val(),
					"partCode"  : $("#partCode").val(),
					"jobPos"    : $("#jobPos").val(),
					"userImg"   : $("#imgSource").val(),
					"enterYmd"  : $("#enterYmd").val(),
					"retireYmd" : $("#retireYmd").val()
				};			
				const data = commonCallAjax("/user/update", params);
				
				if (data.code == "ok") {
					alert("수정되었습니다.");
									
					initGrid();
				}
			}						
		};				
		
		const initGrid = function() {
			const data = commonCallAjax("/user/getUserList", "");
			
			if (data.code == "ok") {
				const result = data.resultList;
				
				if (result.length > 0) {
		        	//Grid draw
					grid = new Tabulator("#gridUser", {
						layout: "fitDataTable",
						height: "450px",	    
					    columns: [
					    	{title: "사번"     , field: "userCode"  , width: 100},
					    	{title: "이름"	   , field: "userName"  , width: 100},
						    {title: "생년월일" , field: "birthYmd"  , width: 120, hozAlign: "center"},
						    {title: "성별"	   , field: "gender"    , width: 100, hozAlign: "center"},
						    {title: "연락처"   , field: "mobile"    , width: 150},
						    {title: "이메일"   , field: "email"     , width: 250},
						    {title: "부서코드" , field: "deptCode"  , visible: false},
						    {title: "부서"	   , field: "deptName"  , width: 130},
						    {title: "파트코드" , field: "partCode"  , visible: false},
						    {title: "파트"     , field: "partName"  , width: 130},
						    {title: "직급코드" , field: "jobPos"    , visible: false},
						    {title: "직급"	   , field: "jobName"    , width: 130},
						    {title: "입사일"   , field: "enterYmd"  , width: 120, hozAlign: "center"},
						    {title: "퇴사일"   , field: "retireYmd" , width: 120, hozAlign: "center"},
						    {title: "이미지"   , field: "userImg"   , visible: false}
					    ]			  
					});		        	

					//Data set
					grid.on("tableBuilt", function(){				
						grid.setData(result);
						grid.on("rowClick", function(e, row) {
							grid.deselectRow();
							row.toggleSelect();
					    	//e - click object
					        //row - row component
					        const rowData = row._row.data;
					    	const gender = rowData.gender == "남" ? "male" : "female";				    	
					    	const email = rowData.email.split("@");
					    	const userImg = rowData.userImg;
					    						    	
					    	$("#userCode").val(rowData.userCode);
					    	$("#userName").val(rowData.userName);
					        $("#birthYmd").val(rowData.birthYmd);
					        $("input:radio[id='"+ gender +"']").prop("checked", true);
					        $("#mobile").val(rowData.mobile);
					        $("#email").val(email[0]);
					        $("#emailServer").val(email[1]);
					        $("#deptCode").val(rowData.deptCode);
					        
					        getPartList(rowData.deptCode);
					        
					        $("#partCode").val(rowData.partCode);
					        $("#jobPos").val(rowData.jobPos);
					        $("#enterYmd").val(rowData.enterYmd);
					        $("#retireYmd").val(rowData.retireYmd);
					        
					        if (commonIsNull(userImg)) {
					        	$("#userImg").attr("src", "/images/userImg.png");
						        $("#imgSource").val("");						        
					        } else {
					        	$("#userImg").attr("src", rowData.userImg);
						        $("#imgSource").val(rowData.userImg);
					        }
					        
					        $("#saveBtn").hide();
					        $("#updateBtn").show();
					    });
					});
					
					$("#divUser").find("input, select").each(function() {
				 		$t = jQuery(this);
				 		$t.removeClass("is-invalid");
				    });
		        }	
			}					    	        
		};
		
		const initObj = function() {
			const data = commonCallAjax("/admin/getDeptList", "");
			const result = data.resultList;
			let dataList = new Array();
			
			for (idx in result) {				
	            let data = new Object();
	             
	            data.codeValue = result[idx].deptCode;
	            data.codeName = result[idx].deptName;

				dataList.push(data);
			}
						
			const comboObj  = {"objId" : "deptCode", "params" : {}, "data" : dataList, "defaultSelected" : "blank"};			
			const comboObj2 = {"objId" : "jobPos", "params" : {"parentCode" : "POS001"}, "defaultSelected" : "blank"};			
			
			commonInitObj(comboObj);
			commonInitObj(comboObj2);
		};
		
		const getPartList = function(deptCode) {
			const data = commonCallAjax("/admin/getPartList", {"deptCode" : deptCode})
			const result = data.resultList;
			let dataList = new Array();
			
			for (idx in result) {				
	            let data = new Object();
	             
	            data.codeValue = result[idx].partCode;
	            data.codeName  = result[idx].partName;

				dataList.push(data);
			}
			
			const comboObj = {"objId" : "partCode", "params" : {}, "data" : dataList, "defaultSelected" : "blank"};
			commonInitObj(comboObj);
		};
		
		$(function() {
			$("#newBtn").on("click", function(){
				$("#updateBtn").hide();
				$("#saveBtn").show();
				
				commonResetForm("divUser");
				
				$("#userImg").attr("src", "/images/userImg.png");
			});
			$("input[name=formDatePicker]").each(function(index, item){
				$("#" + item.id).datepicker(commonDatePickerOpt);
		    });						
			
			initGrid();
			initObj();
		});
	</script>
</th:block>
</html>